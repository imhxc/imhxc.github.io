---
title: GraphQLæµ…å…¥æµ…å‡º
date: 2020-06-22 18:09:48
tags: GraphQL
---

## å‰è¨€

GraphQL ä½œä¸ºç›®å‰è¾ƒä¸ºğŸ”¥çš„ä¸€æ¬¾ API æŸ¥è¯¢è¯­è¨€ï¼Œæ˜¯ä¸€æ¬¾æ¯”è¾ƒæ–°é¢–ã€å‹å¥½çš„æ–°æŠ€æœ¯ã€‚

ç½‘ä¸Šå¤§å¤šæ•°ä¼šå°† GraphQL å’Œ RESTful API å¯¹æ¯”ï¼Œçš„ç¡®ï¼ŒGraphQL çš„å‡ºç°ï¼Œç¦»ä¸å¼€ RESTful APIï¼ŒGraphQL è§£å†³äº† RESTful ä¸€äº›å¼Šç«¯ï¼Œæ¯”å¦‚å½“ä¸šåŠ¡æ¥å£å¤æ‚çš„æ—¶å€™ï¼Œä¼šæœ‰å¤§é‡çš„æ¥å£åœ°å€ï¼ŒåŒæ—¶å¯¹æ¥å£å‘½åä¹ŸåŠ å¤§äº†éš¾åº¦ã€‚

ä½†æ˜¯ï¼ŒGraphQL å¹¶ä¸ç­‰äº RESTfulï¼ŒRESTful æ—¶ä¸€ç§é£æ ¼çº¦å®šï¼Œå…·ä½“å®ç°åˆ™å®Œå…¨æ ¹æ®å¼€å‘è€…æ¥å†³å®šã€‚è€Œ GraphQL åˆ™æ˜¯ä¸€ç§æŸ¥è¯¢è¯­è¨€ï¼Œæœ€ç›´æ¥çš„è¡¨ç°å°±æ˜¯ä½ éœ€è¦å®‰è£…ç›¸åº”çš„ä¾èµ–æ‰å¯ä»¥ä½¿ç”¨ã€‚

> æˆ‘åœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨ RESTful é£æ ¼å¼€å‘æ¥å£çš„æ—¶å€™ï¼Œå¾€å¾€ä¼šé‡åˆ°æ¥å£å‘½åã€å¤æ‚æ¥å£è¾ƒéš¾éµå¾ª RESTful é£æ ¼ã€‚
> ç½‘ä¸Šç»™å‡ºçš„ç¤ºä¾‹æ¸…ä¸€è‰²éƒ½æ˜¯ç®€å•ç¤ºä¾‹ï¼Œæ¯”å¦‚ä½ æ— æ³•è¾ƒå¥½çš„å¤„ç†ä¸‹é¢è¿™å‡ ç§æ¥å£ï¼šå½“åˆ é™¤ä¸€ä¸ªç”¨æˆ·çš„æ—¶å€™ï¼Œä¼šå‡ºç°ä¸åŒçš„è§’è‰²ï¼Œä¸åŒè§’è‰²åˆ é™¤éœ€è¦çš„å‚æ•°ã€ç»“æœè¿”å›éƒ½ä¸åŒã€‚

æœ¬æ–‡ç›¸å…³ä»£ç ï¼š[GitHub - imhxc/egg-graphql-example: graph æµ…å…¥æµ…å‡º](https://github.com/imhxc/egg-graphql-example)

## æ²¡æœ‰ GraphQL çš„æ—¶å€™ï¼Œæˆ‘æ˜¯å¦‚ä½•å¼€å‘çš„ï¼Ÿ

/è¯¥æ®µè½åªæ˜¯è®°å½•äº†æˆ‘è‡ªå·±åœ¨æ²¡æœ‰ä½¿ç”¨ GraphQL å¼€å‘ä¸­é‡åˆ°çš„ç—›ç‚¹ï¼Œä½ å¯ä»¥é€‰æ‹©è·³è¿‡/

åœ¨ Eggã€Koaï¼Œä»¥åŠä¸€äº› php æ¡†æ¶ç­‰ï¼Œç›¸ä¿¡ä½ éƒ½è§è¿‡å¦‚ä¸‹å‡ ä¸ªç›®å½•æˆ–æ–‡ä»¶ï¼š

* router
* controller
* model
* service
* public

æ²¡é”™ï¼Œè¿™æ˜¯æœ€å¸¸è§çš„ MVC æ¨¡å¼ï¼Œå°†è·¯ç”±ã€æ§åˆ¶å™¨ã€æ¨¡å‹å±‚ç­‰è¿›è¡Œäº†åˆ†ç¦»ã€‚

> ä¹Ÿæœ‰å…¶ä»–çš„æ¨¡å¼ï¼Œä½†åŸºæœ¬éƒ½å·®ä¸å¤šï¼Œå¤§ä½“ç»“æ„éƒ½æ˜¯å°†æ¯ä¸ªåŠŸèƒ½ã€æ¨¡å—è¿›è¡Œç›®å½•åˆ’åˆ†ã€‚

ä¸Šé¢è¿™ç§ç»“æ„åˆ’åˆ†åœ¨è¾ƒä¸ºç®€å•çš„é¡¹ç›®ä¸­ç”¨èµ·æ¥å¾—å¿ƒåº”æ‰‹ï¼Œä½†æ˜¯åŒæ ·é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå½“é¡¹ç›®è¾ƒä¸ºå¤æ‚ï¼Œæ¥å£ç”šè‡³è¾¾åˆ°ä¸Šç™¾ä¸ªçš„æ—¶å€™ï¼Œè¿™ç§åˆ’åˆ†ä¼šæ˜¾å¾—æå…¶è‡ƒè‚¿ï¼›

å¾€å¾€ä½ ä¸ºäº†ä¿®æ”¹æˆ–æ·»åŠ ä¸€ä¸ªåŠŸèƒ½ï¼Œè¦å»æ“ä½œä¸åŒç›®å½•ä¸‹çš„ä¸åŒæ–‡ä»¶ã€‚

> æœ‰æ—¶å€™æˆ‘ä¹Ÿä¼šé™·äºå¦ä¸€ç§å›°å¢ƒï¼Œæ¯”å¦‚ï¼šæŸ¥è¯¢æŸä¸ªç­çº§ä¸‹çš„æ‰€æœ‰å­¦ç”Ÿï¼Œä½ ä¸çŸ¥é“æ˜¯è¦å°†è¿™ä¸ªæ“ä½œå’Œæ¥å£å†™åˆ° `clazz.js` æ–‡ä»¶ä¸­ï¼Œè¿˜æ˜¯ `student.js` æ–‡ä»¶ä¸­ã€‚
> ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å½“é‡åˆ°ä¸€ä¸ªåŠŸèƒ½è®¾è®¡ä¸¤ä¸ªæˆ–ä»¥ä¸Šçš„è¡¨çš„æ—¶å€™ï¼Œä½ æ— æ³•å¾ˆå¥½çš„å†³å®šè¿™ä¸ªæ“ä½œåº”è¯¥æ”¾åˆ°å“ªä¸ªæ–‡ä»¶ä¸­ã€‚


## GraphQL åŸºæœ¬ç†è§£

åœ¨ GraphQL ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬æœ‰ä»¥ä¸‹ä¸‰ç§ç»“æ„ï¼ˆæ–‡ä»¶ï¼‰ï¼š

* schema
* resolver
* connector

åœ¨ GraphQL ä¸­ï¼Œ*æ²¡æœ‰ router* ï¼Œä»»ä½•è¡Œä¸ºçš„æ¥å£éƒ½ä½¿ç”¨åŒä¸€ä¸ªæ¥å£ï¼ŒGraphQL ä¼šæ ¹æ®æˆ‘ä»¬ä¼ é€’çš„å‚æ•°ä¸åŒè‡ªè¡Œå¤„ç†ï¼Œè¿™ä¹Ÿå°±æ˜¯è§£å†³äº†å‰é¢æåˆ°çš„ RESTful æ¥å£å¤ªå¤šçš„é—®é¢˜ã€‚


### Schema

Schema æ˜¯ GraphQL ä¸­å¯¹æ•°æ®çš„æè¿°ï¼Œä¸ TypeScript ä¸­çš„ç±»å‹å®šä¹‰æœ‰ç‚¹ç±»ä¼¼ã€‚

æˆ‘ä»¬ä¼šä»å…¶åŸºæœ¬ç»“æ„å’Œä¸¤ä¸ªç‰¹æ®Šç±»å‹å»äº†è§£ã€‚

#### Schema çš„åŸºæœ¬ç»“æ„

````
enum Gender {
  MALE
  FEMALE
  NONE
}
type User {
  name: String!
  gender: Gender!
  tags: [String!]!
}
````

å¦‚æœä½ ä½¿ç”¨è¿‡ TypeScript ï¼Œä¸Šé¢ä»£ç ä¸éš¾ç†è§£ï¼Œæ— éå°±æ˜¯å®šä¹‰äº†ä¸€ä¸ª User å¯¹è¥¿é‚£ä¸ªç±»å‹å’Œä¸€ä¸ª Gender æšä¸¾ç±»å‹ã€‚

è¿™é‡Œéœ€è¦é¢å¤–äº†è§£çš„æ˜¯ `!` ã€`[]`  è¿™ä¸¤ä¸ªä¸ªç¬¦å·ï¼š

* `!`  ï¼šè¡¨ç¤ºè¯¥å­—æ®µä¸ä¸ºç©ºï¼›
* `[]`ï¼šè¡¨ç¤ºè¯¥å­—æ®µæ˜¯ä¸€ä¸ªæ•°ç»„ï¼›
* `[String!]!`ï¼š è¡¨ç¤ºè¯¥å­—æ®µæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„å†…ä¸ä¸ºç©ºï¼Œè€Œä¸”è¯¥å­—æ®µä¹Ÿä¸ä¸ºç©ºã€‚


#### Schema çš„ä¸¤ä¸ªç‰¹æ®Šå¯¹è±¡ç±»å‹

ä¸¤ä¸ªç‰¹æ®Šç±»å‹åˆ†åˆ«æ˜¯ `Query` å’Œ `Mutaion`ï¼Œå³æŸ¥è¯¢å’Œå˜æ›´ç±»å‹ã€‚

æ¯ä¸€ä¸ª GraphQL æœåŠ¡éƒ½æœ‰ä¸€ä¸ª Query ç±»å‹ï¼Œå¯èƒ½ä¼šæœ‰ä¸€ä¸ª  Mutation ç±»å‹ï¼›Query ç”¨äºæŸ¥è¯¢æ•°æ®ï¼ŒMutation ç”¨äºåˆ›å»ºæˆ–å˜æ›´æ•°æ®ã€‚

ä¹‹æ‰€ä»¥è¢«ç§°ä¸ºç‰¹æ®Šç±»å‹ï¼Œæ˜¯å› ä¸ºè¿™ä¸¤ä¸ªç±»å‹æœ‰å…¶ç‰¹å®šçš„å«ä¹‰ï¼Œä½ å¯ä»¥ç†è§£ä¸ºç±»ä¼¼ç¨‹åºä¸­çš„ä¿ç•™å…³é”®å­—ï¼›

*è¿™ä¸¤ä¸ªç‰¹æ®Šç±»å‹å®šä¹‰ä¸ªæ¯ä¸€ä¸ª GraphQL æœåŠ¡çš„å…¥å£*ã€‚

##### Query å¯¹è±¡ç±»å‹

````
# åœ¨ schema ä¸­å®šä¹‰
type Query {
  # æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
  users: [User!]!
  # æ ¹æ® name æŸ¥è¯¢å¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯
  user(name: String!): User
}
````

è¿™é‡Œï¼Œæˆ‘ä»¬åœ¨ schema ä¸­å®šä¹‰äº†ä¸€ä¸ª Query å¯¹è±¡ç±»å‹ï¼Œå…¶ä¸­ `user` å’Œ `users` ä¸ºä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«ç”¨äºæŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·å’Œå•ä¸ªç”¨æˆ·ã€‚

##### Mutation å¯¹è±¡ç±»å‹

````
# åœ¨ schema ä¸­å®šä¹‰
input UserInput {
  name: String!
  gender: Gender! # å‰é¢å·²ç»å®šä¹‰äº† Gender
  tags: [String!]!
}

type Mutation {
  createUser(user: UserInput!): User!
}
````

`input` è¡¨ç¤ºè¾“å…¥å¯¹è±¡ï¼Œå’Œæ™®é€šå¯¹è±¡ä¸€æ ·ï¼Œåªæ˜¯å…³é”®å­—æ˜¯ `input`  è€Œä¸æ˜¯ `type` ï¼›å®ƒçš„ç‰¹åˆ«ä¹‹å¤„åœ¨äºï¼Œè¾“å…¥å¯¹è±¡å¯ä»¥ç”¨åœ¨å¤æ‚çš„å‚æ•°é‡ï¼Œç»å¸¸æ˜¯ `mutation`  å‚æ•°ï¼Œæ¯”å¦‚ä¸Šé¢çš„ä»£ç ã€‚


### Resolver

å‰é¢æˆ‘ä»¬å®šä¹‰åˆ—ä¸€äº› Schemaï¼Œå®šä¹‰å¥½ä¹‹åï¼Œæˆ‘ä»¬å°±éœ€è¦ resolver æ¥å¯¹å…¶è¿›è¡Œæ“ä½œã€‚

åœ¨ GraphQL ä¸­ï¼Œæ¯ä¸ªç±»å‹çš„æ¯ä¸ªå­—æ®µéƒ½ç”±ä¸€ä¸ª resolver å‡½æ•°æ”¯æŒï¼Œå½“ä¸€ä¸ªå­—æ®µè¢«æ‰§è¡Œçš„æ—¶å€™ï¼Œç›¸åº”çš„ resolver ä¼šè¢«è°ƒç”¨ä»¥äº§ç”Ÿä¸‹ä¸€ä¸ªå€¼ã€‚

ä½ å¯ä»¥ç†è§£ä¸º resolver ç­‰äº RESTful ä¸­çš„ controllerï¼Œresolver å‡½æ•°æ˜¯å¯¹ GraphQL å…¥å£çš„å®ç°ã€‚

#### Query

æˆ‘ä»¬è¿™é‡Œæ ¹æ®å‰é¢å®šä¹‰çš„ schema æ¥ç¼–å†™ä¸¤ä¸ª resolver å‡½æ•°ï¼š

````
const resolvers = {
  Query: {
    // å¯¹åº” schema ä¸­å®šä¹‰çš„ Query ç±»å‹ä¸­çš„ users
    users: () => {
      return [
        {
          name: 'Jack',
          gender: 'MALE',
          tags: ['éšå’Œ', 'å¹³æ˜“è¿‘äºº', 'å–„è‰¯']
        },
        {
          name: 'Tome',
          gender: 'NONE',
          tags: ['ä¹äºåŠ©äºº', 'æœ€å¼ºå¤§è„‘']
        },
      ]
    },
    // å¯¹åº” schema ä¸­å®šä¹‰çš„ Query ç±»å‹ä¸­çš„ user
    user: (_root, args) => {
      const { name } = args;
      return {
        name,
        gender: 'MALE',
		  tags: ['éšå’Œ', 'å¹³æ˜“è¿‘äºº', 'å–„è‰¯'],
      }
    }
  }
}
````

åˆ°æ­¤ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ª Query ç±»å‹çš„ resolver å‡½æ•°ï¼Œé€šè¿‡è®¿é—®ç›¸åº”çš„ graph æ¥å£åœ°å€å°±å¯ä»¥è·å¾—æ­£ç¡®çš„æ•°æ®ã€‚

*æŸ¥è¯¢ç¤ºä¾‹ï¼š*

````
{
  users{
    name
    gender
    tags
  }
}
````

ä½ å¯ä»¥è‡ªç”±åˆ å‡ `name`ã€`gender `ã€`tags` è¿™ä¸‰ä¸ªå±æ€§ï¼ŒGraphQL æœåŠ¡ä¼šè‡ªåŠ¨è¿”å›ç›¸åº”çš„æ•°æ®ã€‚


#### Mutation

å‰é¢å®šä¹‰äº† Query æŸ¥è¯¢ï¼Œä½†æ˜¯å®é™…ä¸šåŠ¡ä¸å¯èƒ½åªæœ‰æŸ¥è¯¢ï¼Œä¹Ÿä¼šå­˜åœ¨ä¿®æ”¹æ“ä½œï¼ŒMutation å°±æ˜¯è´Ÿè´£ä¿®æ”¹æ“ä½œçš„ã€‚

åœ¨å‰é¢ï¼Œæˆ‘ä»¬å·²ç»å®šä¹‰äº†å¦‚ä¸‹ schemaï¼š

````
# åŒæ ·åœ¨ schema ä¸­å®šä¹‰ mutation æ“ä½œ
type Mutation {
  createUser(user: UserInput!): User!
}
````

æˆ‘ä»¬åªéœ€è¦åœ¨ resolver ä¸­å®šä¹‰ Mutation ç›¸å…³çš„å‡½æ•°å³å¯ï¼š

````
// åœ¨ resolver ä¸­å®šä¹‰
export default {
  Query: {
	  // ...
  },
  Mutation: {
    createUser: (_root, args) => {
      const { user: { name, gender, tags } } = args;
      return {
        name,
        gender,
        tags,
      };
    },
  },
}
````

æˆ‘ä»¬åœ¨è®² Mutation å’Œ Query å®šä¹‰åœ¨äº†ä¸€èµ·ï¼Œå› ä¸ºéƒ½å±äº resolver å‡½æ•°ã€‚

åˆ°æ­¤ã€‚ä½ åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ graph æœåŠ¡åœ°å€ï¼Œè¾“å…¥å¦‚ä¸‹ï¼š

````
mutation{
  createUser(user: {
    name: "äºŒç‹—è›‹",
    gender: MALE,
    tags: ["ç‹—è›‹å­", "äºŒç‹—å­", "ç‹—å‰©å­"]
  }){
    name
    gender
    tags
  }
}
````

è‡³æ­¤ï¼Œä½ å·²ç»å­¦ä¼šäº† GraphQL åŸºæœ¬çš„æŸ¥è¯¢ã€ä¿®æ”¹æ“ä½œã€‚


## æ€»ç»“

GraphQL å…·æœ‰ä¸¤ä¸ªç‰¹æ®Šç±»å‹ï¼Œåˆ†åˆ«æ˜¯ Query å’Œ Mutationï¼Œè´Ÿè´£æŸ¥è¯¢å’Œä¿®æ”¹ï¼›

åŒæ—¶ Mutation æ²¡æœ‰ routerï¼ŒGraphQL æœåŠ¡ä¼šæ ¹æ®ä½ çš„æŸ¥è¯¢è¯­æ³•è‡ªè¡Œè°ƒç”¨ç›¸å…³å‡½æ•°ã€‚